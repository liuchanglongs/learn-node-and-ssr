# 中间件(middleware)

1. Next.js 的中间件允许我们去`拦截客户端向node服务发起的请求`，例如：API 请求、router 切换、资源加载、站点图片等。

- 拦截客服端发起的请求等等之后，便可对这些进行：重写(反向代理)、路由重定向、修改请求响应标头、或响应等操作。

2. 使用中间件需按照以下步骤操作：
    1.在根目录中创建 middleware.ts 文件
    2.从 middleware.ts 文件中导出一个中间件 middleware 函数（支持 async，并只允许在服务端），会接收两个参数：
   ✓ req：类型为 NextRequest
   ✓ event：类型为 NextFetchEvent
    3.通过返回 NextResponse 对象来实现重定向等功能
   ✓ next()- 将继续中间件链
   ✓ redirect()- 将重定向，如：重定向到某个页面
   ✓ rewrite()- 将重写 URL，如：配置反向代理
    4.没返回值：页面将按预期加载 和 返回 next() 一样

# 匹配器（Matcher）

匹配器允许我们过滤中间件以在特定路径上运行，比如：

- matcher: ‘/about/:path*， 意思是匹配以 /about/* 开头的路径。其中路径开头的：是修饰符， 而 \_ 代表 0 个 或 n 个
- matcher: [‘/about/:path_’, ‘/dashboard/:path*’] ， 意思是匹配以 /about/\* 和 /dashboard/\_ 开头的路径
- matcher: [‘/((?!api|\_next/static|favicon.ico)._)‘] ，意思是不匹配以 api、\_next/static、favicon.ico 开头的路径
   `注意：上面的 path 是占位符， 不是固定的。`

# 中间件(middleware) 与匹配器常见功能实现

1. 路由拦截
2. 重写请求路径 -> 雷士 vue.config 中 devServer-> proxy
3. 资源加载拦截
4. 常见 api: [代码](middleware.ts)

```js
import { NextFetchEvent, NextRequest, NextResponse } from "next/server";

// 1.可以拦截，API请求、router切换、资源加载、站点图片等
// 2.这个中间件只在服务器段运行
export function middleware(req: NextRequest, event: NextFetchEvent) {
  // 1.常用的请求参数
  // console.log("中间=>", req.url);
  // console.log("event", event);

  // 2.返回next()
  // return NextResponse.next(); // 返回next 和 没有返回的效果是一样，直接放行

  // 3.返回的 重定向
  // let token = req.cookies.get("token")?.value;
  // console.log("token=>", token);
  // if (!token && req.nextUrl.pathname !== "/login") {
  //   // 重定向到登录页面
  //   return NextResponse.redirect(new URL("/login", req.nextUrl.origin));
  // }

  // 4.返回的 重写 ->  vue.config  devServer-> proxy
  if (req.nextUrl.pathname.startsWith("/juanpi/api")) {
    // http://locahost:3000/juanpi/api/homeInfo?id=100
    // 重写 url 为下面的 url
    // http://codercba.com:9060/juanpi/api/homeInfo?id=100
    return NextResponse.rewrite(
      new URL(req.nextUrl.pathname, "http://codercba.com:9060")
    );
  }
}

// 匹配器 -> 过滤
export const config = {
  // (?!_next)  匹配不包含 _next 路径
  matcher: ["/((?!_next/static|api|favicon.ico|.well).*)"],
};
```
